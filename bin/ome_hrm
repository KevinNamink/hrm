#!/bin/bash

# hrm.conf defines variables OMERO_PKG
. /etc/hrm.conf

log() {
    echo "$1" >&2
}

usage_exit() {
    if [ -n "$1" ] ; then
        echo "$1"
        echo
    fi
    echo "Usage: $0  { checkCredentials |
                       retrieveUserTree |
                       OMEROtoHRM       |
                       HRMtoOMERO       } args"
    exit 1
}

initialize () {

    if [ -z "$1" ]; then
        usage_exit "Missing user login."
    fi

    if [ -z "$2" ]; then
        usage_exit "Missing user password."
    fi

    USER_LOGIN=$1
    USER_PASSD=$2

    # The user running the OMERO commands (usually the same running apache)
    # needs to have r/w permissions for the $HRM_DATA area.
    OMERO_EXEC="$OMERO_PKG/bin/omero"
}


checkCredentials () {

     initialize $1 $2

     # Try to log in.
     omeroLogin

     # Try to log out in any case.
     omeroLogout

     # If we couldn't get the user id, the credentials weren't Ok.
     if [ -z "$USER_ID" ] ; then
       echo "-1"
     else
       echo $USER_ID
     fi
}


omeroLogin () {

    $OMERO_EXEC login -u $USER_LOGIN \
                      -w $USER_PASSD \
                      -s $OMERO_HOSTNAME \
                      -p $OMERO_PORT

    retrieveUserId
}


omeroLogout () {
    $OMERO_EXEC logout
}


omero_query() {
    # Send a HQL query to the OMERO server and process (reformat) the output so
    # it can be used directly, removing header/footer and surrounding
    # whitespaces. The output format is one result per line, separator for
    # columns is '|' (the pipe character).
    #
    # \param   $QRY        HQL query string for OMERO.

    log "QUERYING OMERO-DB: $1"
    # TODO: capture output of omero-query somewhere
    # by default results are limited to 25, we need to disable this (-1)
    $OMERO_EXEC hql -q --limit -1 "$1" 2>/dev/null |
        tail -n +3 |           # remove first two lines
        head -n -1 |           # remove last line
        sed 's,  *$,,' |       # trim trailing whitespace at line end
        sed 's,  *|  *,|,g' |  # trim leading/trailing WS in columns
        cut -d '|' -f 2-       # cut away first column (results index)
}


retrieveUserId() {
    # Retrieve the user id.
    QRY="SELECT i.id FROM Experimenter i WHERE i.omeName='$USER_LOGIN'"
    USER_ID=$(omero_query "$QRY")
    log "OMERO user ID for username $USER_LOGIN: $USER_ID."
}


retrieveArchivedImageId() {
    if [ -z "$1" ] ; then
        echo "Missing image id."
        return
    fi
    IMAGE_ID=$1

    log "Requesting archived image ID for ID $IMAGE_ID."
    QRY="SELECT o.id FROM Image i JOIN i.pixels p JOIN p.pixelsFileMaps m "
    QRY=$QRY"JOIN m.parent o WHERE i.id=$IMAGE_ID"
    ARCHIVED_ID=$(omero_query "$QRY")
    if [ -n "$ARCHIVED_ID" ] ; then
        log "Archived image ID: $ARCHIVED_ID."
    else
        log "No archived image found for $IMAGE_ID."
    fi
}

get_uniq_cols() {
    echo "$1" | cut -d '|' -f "$2" | sort -n | uniq
}

retrieveUserTree() {

    initialize $1 $2

    omeroLogin $USER_LOGIN $USER_PASSD

    USER_TREE=''

    QRY="SELECT p.id, p.name, ds.id, ds.name, i.id, i.name
         FROM Project p, ProjectDatasetLink pdl, Dataset ds,
             DatasetImageLink dil, Image i
         WHERE pdl.parent=p.id
             AND pdl.child=ds.id
             AND dil.parent=pdl.child
             AND dil.child=i.id"
    RES=$(omero_query "$QRY")

    PROJS=$(get_uniq_cols "$RES" "1,2")
    while read -r proj ; do
        PROJ_ID=$(echo "$proj" | cut -d '|' -f 1)
        PROJ_NAME=$(echo "$proj" | cut -d '|' -f 2)
        USER_TREE+="<Project>$PROJ_NAME<id>$PROJ_ID</id>"

        DATASETS=$(get_uniq_cols "$RES" "1,3,4" |
                   grep "^$PROJ_ID|" | cut -d '|' -f 2-)
        while read -r dset ; do
            DS_ID=$(echo "$dset" | cut -d '|' -f 1)
            DS_NAME=$(echo "$dset" | cut -d '|' -f 2)
            USER_TREE+="<Dataset>$DS_NAME<id>$DS_ID</id>"

            IMAGES=$(get_uniq_cols "$RES" "3,5,6" |
                     grep "^$DS_ID|" | cut -d '|' -f 2-)
            while read -r img ; do
                IMG_ID=$(echo "$img" | cut -d '|' -f 1)
                IMG_NAME=$(echo "$img" | cut -d '|' -f 2)
                USER_TREE+="<Image>$IMG_NAME<id>$IMG_ID</id></Image>"
            done <<< "$IMAGES"
            USER_TREE+="</Dataset>"
        done <<< "$DATASETS"
        USER_TREE+="</Project>"
    done <<< "$PROJS"

    omeroLogout

    echo $USER_TREE
}


exportImage() {
    # Download an image from OMERO to the local filesystem.
    #
    # \param  $USERNAME  OMERO username.
    # \param  $PASSWORD  OMERO password.
    # \param  $ID        OMERO image id.
    # \param  $DEST      Destination to store the downloaded image.
    #
    # NOTE: the OMERO cli has two subcommands to request pixel data from the
    # server: "export" and "download". To retrieve OME-TIFFs, the "export"
    # command has to be used as "download" provides access to the file in its
    # original format, which only works if the "archive" box was checked by the
    # user when initially uploading the data into the OMERO server.
    #
    # NOTE2: the above statement is true for OMERO-4, the situation for OMERO-5
    # still has to be evaluated!

    initialize $1 $2

    if [ -z "$3" ] ; then
        echo "Missing Omero's image id."
        return
    fi
    IMAGE_ID=$3

    if [ -z "$4" ] ; then
        echo "Missing image destination path."
        return
    fi
    IMAGE_DEST=$4

    omeroLogin $USER_LOGIN $USER_PASSD

    log "Requesting image $IMAGE_ID from OMERO to be exported as $IMAGE_DEST."
    $OMERO_EXEC export --file $IMAGE_DEST Image:$IMAGE_ID

    omeroLogout
}


importImage () {

    initialize $1 $2

    if [ -z "$3" ];
    then
        echo "Missing Omero's dataset id.\n"
    else
        DATASET_ID=$3
    fi

    if [ -z "$4" ];
    then
        echo "Missing path to image.\n"
    else
        IMAGE_PATH=$4
    fi

    if [ -z "$5" ];
    then
        echo "Missing image name.\n"
    else
        IMAGE_NAME=$5
    fi

    if [ -z "$6" ];
    then
        echo "Missing annotation text.\n"
    else
        ANNOTATION_TEXT="$6"
    fi

    omeroLogin $USER_LOGIN $USER_PASSD

    $OMERO_EXEC import $IMAGE_PATH -d $DATASET_ID -n $IMAGE_NAME \
        -c -x "Deconvolved with Huygens" \
        --annotation_ns "HuygensDeconvolved" \
        --annotation_text "$ANNOTATION_TEXT"

    omeroLogout
}


# ------------------------------ 'Main' ------------------------------------- #

COMMAND="$1"
shift

case $COMMAND in
    checkCredentials)
        checkCredentials "$@"
        ;;
    retrieveUserTree)
        retrieveUserTree "$@"
        ;;
    OMEROtoHRM)
        exportImage "$@"
        ;;
    HRMtoOMERO)
        importImage "$@"
        ;;
    *)
        usage_exit
esac
