#!/bin/bash

# hrm.conf defines variables OMERO_PKG
. /etc/hrm.conf

log() {
    echo "$*" >&2
}

usage_exit() {
    if [ -n "$1" ] ; then
        echo "$1"
        echo
    fi
    echo "Usage: $0 <command> <arguments>

Commands:

    checkCredentials      check if login credentials are valid
    retrieveUserTree      retrieve a user's Projects/Datasets/Images tree
    OMEROtoHRM            download an image from the OMERO server
    HRMtoOMERO            upload an image to the OMERO server

Arguments:

    username              the OMERO account name to use for logging in
    password              the corresponding OMERO password"
    exit 1
}

initialize () {
    # 1) check required parameters and assign them to global variables with a
    # name reflecting their function
    # 2) assign global variables OMERO_EXEC and PYTHONPATH

    if [ -z "$OMERO_HOSTNAME" ] ; then
        echo "OMERO hostname missing, check your configuration!"
        exit 2
    fi

    if [ -z "$OMERO_PORT" ] ; then
        echo "OMERO port missing, check your configuration!"
        exit 2
    fi

    if [ -z "$1" ]; then
        usage_exit "Missing user login."
    fi

    if [ -z "$2" ]; then
        usage_exit "Missing user password."
    fi

    USER_LOGIN=$1
    USER_PASSD=$2

    # The user running the OMERO commands (usually the same running apache)
    # needs to have r/w permissions for the $HRM_DATA area.
    OMERO_EXEC="$OMERO_PKG/bin/omero"
    PYTHONPATH="$OMERO_PKG/lib/python"
    export PYTHONPATH
}


checkCredentials () {
     bin/ome_hrm.py -u $USER_LOGIN -w $USER_PASSD checkCredentials
}


retrieveUserTree() {
    bin/ome_hrm.py -u $USER_LOGIN -w $USER_PASSD retrieveUserTree
}


exportImage() {
    # Download an image from OMERO to the local filesystem.
    bin/ome_hrm.py \
        --user $USER_LOGIN \
        --password $USER_PASSD \
        OMEROtoHRM \
        --imageid $3 \
        --dest "$4"
}


importImage() {
    # Upload a deconvolved image from the local filesystem to OMERO.
    bin/ome_hrm.py \
        --user $USER_LOGIN \
        --password $USER_PASSD \
        HRMtoOMERO \
        --dset $3 \
        --file "$4" \
        --name "$5" \
        --ann "$6"

    # $OMERO_EXEC import "$IMAGE_PATH" \
    #     -d $DATASET_ID \
    #     -n "$IMAGE_NAME" \
    #     -c \
    #     -x "Deconvolved with Huygens / HRM" \
    #     --annotation_ns "HuygensHRMDeconvolved" \
    #     --annotation_text "$ANNOTATION_TEXT"
}


# ------------------------------ 'Main' ------------------------------------- #

if [ "$#" -lt 3 ] ; then
    usage_exit
fi

COMMAND="$1"
shift

initialize $1 $2

case $COMMAND in
    checkCredentials)
        checkCredentials "$@"
        ;;
    retrieveUserTree)
        retrieveUserTree "$@"
        ;;
    OMEROtoHRM)
        exportImage "$@"
        ;;
    HRMtoOMERO)
        importImage "$@"
        ;;
    *)
        usage_exit
esac
