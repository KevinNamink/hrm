#!/bin/bash

# hrm.conf defines variables OMERO_PKG
. /etc/hrm.conf

log() {
    echo "$*" >&2
}

usage_exit() {
    if [ -n "$1" ] ; then
        echo "$1"
        echo
    fi
    echo "Usage: $0 <command> <arguments>

Commands:

    checkCredentials      check if login credentials are valid
    retrieveUserTree      retrieve a user's Projects/Datasets/Images tree
    OMEROtoHRM            download an image from the OMERO server
    HRMtoOMERO            upload an image to the OMERO server

Arguments:

    username              the OMERO account name to use for logging in
    password              the corresponding OMERO password"
    exit 1
}

initialize () {
    # 1) check required parameters and assign them to global variables with a
    # name reflecting their function
    # 2) assign global variables OMERO_EXEC and PYTHONPATH

    if [ -z "$OMERO_HOSTNAME" ] ; then
        echo "OMERO hostname missing, check your configuration!"
        exit 2
    fi

    if [ -z "$OMERO_PORT" ] ; then
        echo "OMERO port missing, check your configuration!"
        exit 2
    fi

    if [ -z "$1" ]; then
        usage_exit "Missing user login."
    fi

    if [ -z "$2" ]; then
        usage_exit "Missing user password."
    fi

    USER_LOGIN=$1
    USER_PASSD=$2

    # The user running the OMERO commands (usually the same running apache)
    # needs to have r/w permissions for the $HRM_DATA area.
    OMERO_EXEC="$OMERO_PKG/bin/omero"
    PYTHONPATH="$OMERO_PKG/lib/python"
    export PYTHONPATH
}


checkCredentials () {
     # check for valid credentials by logging in and out with the OMERO server
     initialize $1 $2

     bin/ome_hrm.py -u $USER_LOGIN -w $USER_PASSD checkCredentials
}


omeroLogin () {

    log "Trying to log into OMERO."
    # log "> $OMERO_EXEC login -u $USER_LOGIN -w **** -s $OMERO_HOSTNAME -p $OMERO_PORT"
    $OMERO_EXEC login -u $USER_LOGIN \
                      -w $USER_PASSD \
                      -s $OMERO_HOSTNAME \
                      -p $OMERO_PORT

    retrieveUserId
}


omeroLogout () {
    $OMERO_EXEC logout
}


omero_query() {
    # Send a HQL query to the OMERO server and process (reformat) the output so
    # it can be used directly, removing header/footer and surrounding
    # whitespaces. The output format is one result per line, separator for
    # columns is '|' (the pipe character).
    #
    # \param   $QRY        HQL query string for OMERO.

    log "QUERYING OMERO-DB: $1"
    # TODO: capture output of omero-query somewhere
    # by default results are limited to 25, we need to disable this (-1)
    $OMERO_EXEC hql -q --limit -1 "$1" 2>/dev/null |
        tail -n +3 |           # remove first two lines
        head -n -1 |           # remove last line
        sed 's,  *$,,' |       # trim trailing whitespace at line end
        sed 's,  *|  *,|,g' |  # trim leading/trailing WS in columns
        cut -d '|' -f 2-       # cut away first column (results index)
}

get_uniq_cols() {
    # Convenience function to be used with results of omero_query() that
    # returns a subset of the |-delimited text with only the requested columns,
    # sorted and without duplicates.
    echo "$1" | cut -d '|' -f "$2" | sort -n | uniq
}


retrieveUserId() {
    # Retrieve the user id.
    QRY="SELECT i.id FROM Experimenter i WHERE i.omeName='$USER_LOGIN'"
    USER_ID=$(omero_query "$QRY")
    if [ -z "$USER_ID" ] ; then
        log "ERROR retrieving OMERO user ID for username $USER_LOGIN."
    else
        log "OMERO user ID for username $USER_LOGIN: $USER_ID."
    fi
}


retrieveUserTree() {

    initialize $1 $2

    bin/ome_hrm.py -u $USER_LOGIN -w $USER_PASSD retrieveUserTree
}


exportImage() {
    # Download an image from OMERO to the local filesystem.
    #
    # \param  $USERNAME  OMERO username.
    # \param  $PASSWORD  OMERO password.
    # \param  $ID        OMERO image id.
    # \param  $DEST      Destination to store the downloaded image.

    initialize $1 $2
    bin/ome_hrm.py \
        -u $USER_LOGIN \
        -w $USER_PASSD \
        OMEROtoHRM \
        -i $3 \
        -d "$4"
}


importImage() {
    # Upload a deconvolved image from the local filesystem to OMERO.
    #
    # \param  $USERNAME         OMERO username.
    # \param  $PASSWORD         OMERO password.
    # \param  $DATASET_ID       OMERO dataset id.
    # \param  $IMAGE_PATH       Path of image to be uploaded.
    # \param  $IMAGE_NAME       Name of image to be uploaded.
    # \param  $ANNOTATION_TEXT  Text to be added as annotation in OMERO.

    initialize $1 $2

    if [ -z "$3" ];
    then
        echo "Missing OMERO's dataset id."
    else
        DATASET_ID=$3
    fi

    if [ -z "$4" ];
    then
        echo "Missing path to image."
    else
        IMAGE_PATH="$4"
    fi

    if [ -z "$5" ];
    then
        echo "Missing image name."
    else
        IMAGE_NAME="$5"
    fi

    if [ -z "$6" ];
    then
        echo "Missing annotation text."
    else
        ANNOTATION_TEXT="$6"
    fi

    omeroLogin $USER_LOGIN $USER_PASSD

    # FIXME: why the "-c" flag (continue after errors) ??
    $OMERO_EXEC import "$IMAGE_PATH" \
        -d $DATASET_ID \
        -n "$IMAGE_NAME" \
        -c \
        -x "Deconvolved with Huygens / HRM" \
        --annotation_ns "HuygensHRMDeconvolved" \
        --annotation_text "$ANNOTATION_TEXT"

    omeroLogout
}


# ------------------------------ 'Main' ------------------------------------- #

if [ "$#" -lt 3 ] ; then
    usage_exit
fi

COMMAND="$1"
shift

case $COMMAND in
    checkCredentials)
        checkCredentials "$@"
        ;;
    retrieveUserTree)
        retrieveUserTree "$@"
        ;;
    OMEROtoHRM)
        exportImage "$@"
        ;;
    HRMtoOMERO)
        importImage "$@"
        ;;
    *)
        usage_exit
esac
